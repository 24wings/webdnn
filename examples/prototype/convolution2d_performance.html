<title>Performance Test: Convolution2D</title>

<h1>Performance Test: Convolution2D</h1>
<p>
    Open Debug Console and Run <code>main()</code> Function.
</p>

<script src="./gpgpu.js"></script>
<script src="./functions/warmup.js"></script>
<script src="./functions/convolution2d.js"></script>
<script src="./test_harness.js"></script>
<script>
    async function initialize() {
        if (!GPGPU.isBrowserSupported) {
            console.warn('WebGPURenderingContext is not supported in this browser.');
            return;
        }

        await GPGPU.loaded;
    }

    function createConv2dNaiveTest(desc) {
        const numIteration = 10;
        let X, W, Y;

        return {
            name: `convolution2d-naive`,
            pre: () => {
                X = new Float32Array(desc.batchsize * desc.c1 * desc.h1 * desc.w1);
                W = new Float32Array(desc.c2 * desc.c1 * desc.kh * desc.kw);
                Y = new Float32Array(desc.batchsize * desc.c2 * desc.h2 * desc.w2);
            },
            main: () => {
                for (let i = 0; i < numIteration; i++) convolution2dNaive(desc, X, W, Y);
            },
            post: () => {
                delete X;
                delete W;
                delete Y;
            },
            summarize: (elapsedTime) => {
                return {
                    'kernel': `convolution2d-naive`,
                    '#batch': desc.batchsize,
                    '#channel_in': desc.c1,
                    '#channel_out': desc.c2,
                    'image size': desc.h1,
                    'kernel': desc.kh,
                    'stride': desc.sh,
                    'padding': desc.ph,
                    'elapsed time [ms]': elapsedTime.toFixed(2)
                }
            }
        };
    }

    async function main() {
        try {
            await initialize();

            await TestHarness.runPerformanceTestAsync(createConv2dNaiveTest(new Convolution2dDescriptor({
                batchsize: 1,
                size: 32,
                channels: [128, 128]
            })));

            await TestHarness.runPerformanceTestAsync(createConv2dNaiveTest(new Convolution2dDescriptor({
                batchsize: 1,
                size: 16,
                channels: [256, 256]
            })));

            await TestHarness.runPerformanceTestAsync(createConv2dNaiveTest(new Convolution2dDescriptor({
                batchsize: 1,
                size: 8,
                channels: [512, 512]
            })));

            TestHarness.showSummaryAsTable();

        } catch (e) {
            console.error(e);
        }
    }
</script>