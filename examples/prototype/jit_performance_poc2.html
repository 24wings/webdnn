<title>Performance Test: Convolution2D</title>
<meta charset="utf-8">

<h1>Performance Test: Convolution2D</h1>
<p>
    element-wiseな処理(reluとBN-test)を、バラバラのカーネルで実行する場合と、まとめて実行する場合での性能比較
</p>
<p>
    JSの呼び出しが律速になってしまうような小さなkernelの場合は、まとめて１つにすることでオーバーヘッドを隠蔽できる。
</p>
<p>
    Open Debug Console and Run <code>main()</code> Function.
</p>

<script src="./gpgpu.js"></script>
<script src="./functions/warmup.js"></script>
<script src="./functions/elementwise.js"></script>
<script src="./test_harness.js"></script>
<script>
    async function initialize() {
        if (!GPGPU.isBrowserSupported) {
            console.warn('WebGPURenderingContext is not supported in this browser.');
            return;
        }

        await GPGPU.loaded;
    }

    function createTest(N, isBNOnly, isReluOnly, isJitEnabled) {
        const numIteration = 30;
        let X;

        return {
            name: isBNOnly ?
                'BN' : isReluOnly ?
                'ReLU' : isJitEnabled ?
                'BN+ReLU (JIT)' : 'BN+ReLU',
            pre: () => {
                X = new Float32Array(N);

                for (let i = 0; i < X.length; i++) X[i] = Math.random() - 0.5;
            },
            main: isBNOnly ?
                () => {
                    for (let i = 0; i < numIteration; i++) inplaceFixedBN(N, X);
                } : isReluOnly ?
                () => {
                    for (let i = 0; i < numIteration; i++) inplaceRelu(N, X);
                } : isJitEnabled ?
                () => {
                    for (let i = 0; i < numIteration; i++) inplaceReluAndFixedBN(N, X);
                } :
                () => {
                    for (let i = 0; i < numIteration; i++) {
                        inplaceRelu(N, X);
                        inplaceFixedBN(N, X);
                    }
                },
            post: () => {
                delete X;
            },
            summarize: (elapsedTime) => {
                return {
                    'type': isBNOnly ? 'BN' : isReluOnly ? 'ReLU' : isJitEnabled ? 'BN+ReLU (JIT)' : 'BN+ReLU',
                    '#elements': N,
                    'elapsed time [ms]': (elapsedTime / numIteration).toFixed(2)
                }
            }
        };
    }

    async function main() {
        try {
            await initialize();

            await TestHarness.runPerformanceTestAsync(createTest(128 * 128 * 32 * 32, 1, 0, 0));
            await TestHarness.runPerformanceTestAsync(createTest(128 * 128 * 32 * 32, 0, 1, 0));
            await TestHarness.runPerformanceTestAsync(createTest(128 * 128 * 32 * 32, 0, 0, 0));
            await TestHarness.runPerformanceTestAsync(createTest(128 * 128 * 32 * 32, 0, 0, 1));


            await TestHarness.runPerformanceTestAsync(createTest(128 * 256 * 16 * 16, 1, 0, 0));
            await TestHarness.runPerformanceTestAsync(createTest(128 * 256 * 16 * 16, 0, 1, 0));
            await TestHarness.runPerformanceTestAsync(createTest(128 * 256 * 16 * 16, 0, 0, 0));
            await TestHarness.runPerformanceTestAsync(createTest(128 * 256 * 16 * 16, 0, 0, 1));


            await TestHarness.runPerformanceTestAsync(createTest(128 * 512 * 8 * 8, 1, 0, 0));
            await TestHarness.runPerformanceTestAsync(createTest(128 * 512 * 8 * 8, 0, 1, 0));
            await TestHarness.runPerformanceTestAsync(createTest(128 * 512 * 8 * 8, 0, 0, 0));
            await TestHarness.runPerformanceTestAsync(createTest(128 * 512 * 8 * 8, 0, 0, 1));


            TestHarness.showSummaryAsTable();

        } catch (e) {
            console.error(e);
        }
    }
</script>