<title>Performance Test: sgemm</title>

<h1>Performance Test: sgemm</h1>
<p>
    Open Debug Console and Run <code>main()</code> Function.
</p>

<script src="./gpgpu.js"></script>
<script src="./functions/warmup.js"></script>
<script src="./functions/sgemm.js"></script>
<script src="./test_harness.js"></script>
<script>
    async function initialize() {
        if (!GPGPU.isBrowserSupported) {
            console.warn('WebGPURenderingContext is not supported in this browser.');
            return;
        }

        await GPGPU.loaded;
    }

    function createTest(N, useNaiveKernel) {
        const numIteration = 30;
        let A, B, C;

        return {
            name: `sgemm-${useNaiveKernel?'naive-':''}${N}`,
            pre: () => {
                A = GPGPU.createBuffer(new Float32Array(N * N));
                B = GPGPU.createBuffer(new Float32Array(N * N));
                C = GPGPU.createBuffer(new Float32Array(N * N));
            },
            main: useNaiveKernel ?
                () => {
                    for (let i = 0; i < numIteration; i++) sgemmNaive(N, N, N, 1.0, A, B, 0.0, C);
                } :
                () => {
                    for (let i = 0; i < numIteration; i++) sgemm(N, N, N, 1.0, A, B, 0.0, C);
                },
            post: () => {
                delete A;
                delete B;
                delete C;
            },
            summarize: (elapsedTime) => {
                let flops = (N * N * N * numIteration) / (elapsedTime / 1e3);

                return {
                    'kernel': `sgemm${useNaiveKernel?'-naive':''}`,
                    'size': N,
                    'elapsed time [ms]': elapsedTime.toFixed(2),
                    'FLOPS [G op/s]': (flops / 1e9).toFixed(2)
                }
            }
        };
    }

    async function main() {
        try {
            await initialize();

            await TestHarness.runPerformanceTestAsync(createTest(64, true));
            await TestHarness.runPerformanceTestAsync(createTest(64, false));
            await TestHarness.runPerformanceTestAsync(createTest(128, true));
            await TestHarness.runPerformanceTestAsync(createTest(128, false));
            await TestHarness.runPerformanceTestAsync(createTest(256, true));
            await TestHarness.runPerformanceTestAsync(createTest(256, false));
            await TestHarness.runPerformanceTestAsync(createTest(512, true));
            await TestHarness.runPerformanceTestAsync(createTest(512, false));
            await TestHarness.runPerformanceTestAsync(createTest(1024, true));
            await TestHarness.runPerformanceTestAsync(createTest(1024, false));
            await TestHarness.runPerformanceTestAsync(createTest(2048, true));
            await TestHarness.runPerformanceTestAsync(createTest(2048, false));

            TestHarness.showSummaryAsTable();

        } catch (e) {
            console.error(e);
        }
    }
</script>